# School Directory — Next.js + Supabase with Authentication

This is a complete school directory application with user authentication, email verification, and CRUD operations.

## Features
- **Authentication System**:
  - User registration with email/password
  - Email verification using OTP (via Resend)
  - JWT-based session management
  - Protected routes for authenticated users
- **School Management**:
  - Add School page (form + image upload) - Protected
  - Show Schools page (grid of school cards) - Public
- **Backend**:
  - Supabase for Postgres database + Storage
  - Custom authentication API routes
  - Email sending via Resend API

## Setup

### 1. Install dependencies
```bash
npm install
```

### 2. Database Setup (Supabase)

Create these tables in your Supabase SQL Editor:

**Users Table:**
```sql
create table public.users (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  email text not null,
  verified boolean not null default false,
  password text not null,
  extra json not null default '{}'::json,
  constraint users_pkey primary key (id),
  constraint users_email_key unique (email)
) TABLESPACE pg_default;

-- Enable RLS
alter table public.users enable row level security;
```

**Schools Table:**
```sql
create table if not exists public.schools (
  id bigint generated by default as identity primary key,
  name text not null,
  address text not null,
  city text not null,
  state text not null,
  contact text not null,
  image_url text,
  email text not null,
  created_at timestamptz default now()
);

alter table public.schools enable row level security;

create policy "Public can read schools"
  on public.schools for select
  to public
  using (true);

create policy "Service role can insert"
  on public.schools for insert
  to service_role
  with check (true);
```

### 3. Storage Setup
Create a public storage bucket named `school-image` in your Supabase dashboard.

### 4. Environment Variables
Copy `.env.example` to `.env.local` and fill in the values:

```env
# Your existing Supabase config
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# Add these new variables:
JWT_SECRET=your_very_secure_jwt_secret_key_here
RESEND_API_KEY=re_your_resend_api_key_here
```

**Getting API Keys:**
- **Resend API Key**: Sign up at [resend.com](https://resend.com), verify your domain, and get your API key
- **JWT Secret**: Generate a secure random string (you can use: `openssl rand -base64 32`)

### 5. Run the development server
```bash
npm run dev
```

## Authentication Flow

1. **Sign Up**: User enters email/password → Account created → OTP sent to email
2. **Email Verification**: User enters 6-digit OTP → Account verified → JWT token issued
3. **Login**: User enters email/password → JWT token issued (if verified)
4. **Protected Routes**: JWT token validated on each request to protected pages

## API Routes

- `POST /api/auth` - Main authentication endpoint
  - `action: "signup"` - Create new user account
  - `action: "verify"` - Verify email with OTP
  - `action: "login"` - User login
- `POST /api/auth/resend-otp` - Resend verification code
- `GET /api/auth/me` - Get current user info
- `GET|POST /api/schools` - CRUD operations for schools

## Project Structure

```
app/
├── api/auth/          # Authentication API routes
├── auth/login/        # Login/Register page
├── add-school/        # Add school page (protected)
├── schools/           # Show schools page
components/
├── AuthContext.js     # Authentication context
├── ProtectedRoute.js  # Route protection wrapper
├── Header.js          # Navigation with auth state
lib/
├── auth.js           # JWT utilities
├── supabaseClient.js # Supabase client
```

## Usage

1. Visit `/auth/login` to register or sign in
2. Check your email for the verification code after signup
3. Once verified, you can access protected routes like `/add-school`
4. View all schools at `/schools` (public access)

## Testing the Authentication

1. Start the development server: `npm run dev`
2. Go to `http://localhost:3000/auth/login`
3. Click "Sign Up" tab and create a new account
4. Check your email for the verification code
5. Enter the 6-digit code to verify your account
6. You'll be automatically logged in and redirected to the home page
7. Try accessing `/add-school` - you should now have access
8. Logout and try accessing `/add-school` again - you should be redirected to login

## Environment Variables Required

Make sure to set these in your `.env.local` file:
- `NEXT_PUBLIC_SUPABASE_URL` - Your Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Your Supabase anon key
- `JWT_SECRET` - A secure random string for JWT signing
- `RESEND_API_KEY` - Your Resend API key for sending emails

